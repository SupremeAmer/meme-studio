<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Meme Social</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap">
  <style>
    /* ...same as before, with a few additions for new features... */
    .section { margin-bottom:2rem;}
    #leaderboard, #adminPanel, #dmPanel, #notificationsPanel {
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 1.2rem 1rem;
      margin-bottom: 1.2rem;
      transition: background 0.4s, color 0.4s;
    }
    .darkmode #leaderboard, .darkmode #adminPanel, .darkmode #dmPanel, .darkmode #notificationsPanel {
      background: #283245;
      color: #fff;
    }
    #leaderboard ol { margin-left: 1.2em; }
    #dmMessages { max-height:180px; overflow:auto; margin-bottom:1em;}
    .dm-message { background:#eaf2ff; margin:4px 0; border-radius:0.7em; padding:0.6em;}
    .dm-message.you { background:#b5e0ff; }
    .darkmode .dm-message, .darkmode .dm-message.you { background: #33405c; }
    #notificationsList { max-height:160px; overflow:auto; }
    .notification-item { padding:0.3em 0; border-bottom:1px solid #eee; }
    .admin-meme { display:flex; align-items:center; margin-bottom:1em;}
    .admin-meme img { width:60px; height:60px; object-fit:cover; margin-right:1em;}
    .flag-btn {background:#e53e3e; color:#fff; border:none; border-radius:0.5em; padding:0.4em 0.8em; cursor:pointer;}
    .remove-btn {background:#222c36; color:#fff; border:none; border-radius:0.5em; padding:0.4em 0.8em; cursor:pointer;}
  </style>
</head>
<body>
  <nav class="navbar">
    <span>Meme Social</span>
    <span class="actions">
      <button class="btn" id="darkBtn" title="Toggle dark mode">üåô</button>
      <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
    </span>
  </nav>
  <div class="container">
    <div id="authCard" class="card"></div>
    <div id="appCard" class="card hidden">
      <div id="userWelcome"></div>
      <form id="memeForm" enctype="multipart/form-data">
        <h3>Post a Meme</h3>
        <input type="file" id="memeFile" accept="image/*" required class="input" /><br>
        <input type="text" id="memeCaption" placeholder="Caption" class="input" maxlength="160" required>
        <button type="submit" class="btn">Post Meme</button>
        <div id="memeFormError" class="error"></div>
      </form>
    </div>
    <div class="section" id="notificationsPanel" style="display:none;">
      <h3>Notifications</h3>
      <div id="notificationsList"></div>
    </div>
    <div class="section" id="leaderboard" style="display:none;">
      <h3>Leaderboard</h3>
      <ol id="leaderboardList"></ol>
    </div>
    <div class="section" id="dmPanel" style="display:none;">
      <h3>Direct Messages</h3>
      <select id="dmUserSelect" class="input"></select>
      <div id="dmMessages"></div>
      <form id="dmForm">
        <input type="text" id="dmInput" class="input" placeholder="Type a message..." maxlength="200" required>
        <button class="btn" type="submit">Send</button>
      </form>
    </div>
    <div class="section" id="adminPanel" style="display:none;">
      <h3>Admin Panel</h3>
      <div id="flaggedMemes"></div>
    </div>
    <div id="feedSection">
      <h3>Latest Memes</h3>
      <div id="feedEmpty" class="feed-empty">No memes yet! Be the first to create one.</div>
      <div id="memeFeed"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  <script>
    // ==== Appwrite Config ====
    const APPWRITE_ENDPOINT = "https://fra.cloud.appwrite.io/v1";
    const APPWRITE_PROJECT = "683de53b0032c338fa4b";
    const APPWRITE_DB = "683de6560007db2161b7";
    const APPWRITE_COLLECTION = "Meme";
    const APPWRITE_BUCKET = "memes-bucket";
    const APPWRITE_USERS = "users"; // Custom collection for user profiles
    const APPWRITE_DMS = "dms"; // For direct messages
    const APPWRITE_NOTIFS = "notifications"; // For notifications
    const ADMIN_EMAILS = ["admin@example.com"]; // Add your admin emails

    const client = new window.appwrite.Client();
    client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT);
    const account = new window.appwrite.Account(client);
    const databases = new window.appwrite.Databases(client);
    const storage = new window.appwrite.Storage(client);
    const realtime = new window.appwrite.Realtime(client);
    const ID = window.appwrite.ID;

    // ==== DOM Elements ====
    const authCard = document.getElementById('authCard');
    const appCard = document.getElementById('appCard');
    const memeForm = document.getElementById('memeForm');
    const memeFile = document.getElementById('memeFile');
    const memeCaption = document.getElementById('memeCaption');
    const memeFormError = document.getElementById('memeFormError');
    const memeFeed = document.getElementById('memeFeed');
    const userWelcome = document.getElementById('userWelcome');
    const feedEmpty = document.getElementById('feedEmpty');
    const logoutBtn = document.getElementById('logoutBtn');
    const darkBtn = document.getElementById('darkBtn');
    // New features:
    const leaderboardPanel = document.getElementById('leaderboard');
    const leaderboardList = document.getElementById('leaderboardList');
    const adminPanel = document.getElementById('adminPanel');
    const flaggedMemes = document.getElementById('flaggedMemes');
    const dmPanel = document.getElementById('dmPanel');
    const dmUserSelect = document.getElementById('dmUserSelect');
    const dmMessages = document.getElementById('dmMessages');
    const dmForm = document.getElementById('dmForm');
    const dmInput = document.getElementById('dmInput');
    const notificationsPanel = document.getElementById('notificationsPanel');
    const notificationsList = document.getElementById('notificationsList');

    // ==== State ====
    let user = null;
    let memes = [];
    let allUsers = [];
    let selectedDMUser = null;
    let myNotifs = [];
    let myDMSubscription = null;
    let unsubscribeFeed = null;

    // ==== Auth ====
    async function checkSession() {
      try {
        user = await account.get();
        showApp();
      } catch {
        showAuth();
      }
    }

    function showAuth() {
      authCard.innerHTML = `
        <h2>Meme Social</h2>
        <form id="authForm">
          <input type="email" placeholder="Email" id="email" required class="input" />
          <input type="password" placeholder="Password" id="password" required class="input" />
          <button type="submit" class="btn" id="authBtn">Login</button>
          <div>
            <a href="#" id="toggleAuth">Don't have an account? Register</a>
          </div>
          <div id="authError" class="error"></div>
        </form>
      `;
      appCard.classList.add('hidden');
      authCard.classList.remove('hidden');
      leaderboardPanel.style.display = "none";
      adminPanel.style.display = "none";
      dmPanel.style.display = "none";
      notificationsPanel.style.display = "none";
      memeFeed.innerHTML = "";
      feedEmpty.style.display = "block";
      let isRegister = false;
      const authForm = document.getElementById('authForm');
      const authBtn = document.getElementById('authBtn');
      const toggleAuth = document.getElementById('toggleAuth');
      const authError = document.getElementById('authError');
      toggleAuth.addEventListener("click", e => {
        e.preventDefault();
        isRegister = !isRegister;
        authBtn.textContent = isRegister ? "Register" : "Login";
        toggleAuth.textContent = isRegister ? "Already have an account? Sign in" : "Don't have an account? Register";
        authError.textContent = "";
      });
      authForm.addEventListener("submit", async e => {
        e.preventDefault();
        authError.textContent = "";
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
          if (isRegister) {
            await account.create('unique()', email, password);
            // Also create user profile doc
            await databases.createDocument(APPWRITE_DB, APPWRITE_USERS, ID.unique(), {
              email: email,
              memes: 0,
              likes: 0,
              isAdmin: ADMIN_EMAILS.includes(email)
            });
          }
          await account.createEmailSession(email, password);
          user = await account.get();
          showApp();
        } catch (err) {
          authError.textContent = err.message || "Authentication failed";
        }
      });
    }

    logoutBtn.onclick = async () => {
      await account.deleteSession("current");
      user = null;
      if (unsubscribeFeed) unsubscribeFeed();
      if (myDMSubscription) myDMSubscription();
      showAuth();
    };

    // ==== Dark Mode ====
    darkBtn.onclick = () => {
      document.body.classList.toggle('darkmode');
    };

    // ==== Meme Posting ====
    memeForm.onsubmit = async (e) => {
      e.preventDefault();
      memeFormError.textContent = "";
      if (!memeFile.files[0]) {
        memeFormError.textContent = "Please select a meme image!";
        return;
      }
      try {
        // Upload file to Appwrite Storage
        const file = memeFile.files[0];
        const fileUpload = await storage.createFile(APPWRITE_BUCKET, ID.unique(), file);
        const fileId = fileUpload.$id;
        // Create meme document
        await databases.createDocument(APPWRITE_DB, APPWRITE_COLLECTION, ID.unique(), {
          image: fileId,
          caption: memeCaption.value,
          user: user.email,
          likes: 0,
          reactions: {},
          comments: [],
          flagged: false
        });
        // Update user meme count
        const uDoc = await getUserDoc(user.email);
        if (uDoc)
          await databases.updateDocument(APPWRITE_DB, APPWRITE_USERS, uDoc.$id, { memes: (uDoc.memes||0)+1 });
        memeFile.value = "";
        memeCaption.value = "";
      } catch(err) {
        memeFormError.textContent = err.message || "Failed to post meme.";
      }
    };

    // ==== Feed Rendering ====
    async function fetchMemes() {
      try {
        const docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_COLLECTION, ['orderDesc($createdAt)']);
        memes = docs.documents;
        renderFeed();
      } catch {
        memeFeed.innerHTML = '<div class="error">Failed to load memes.</div>';
      }
    }

    function renderFeed() {
      memeFeed.innerHTML = "";
      if (!memes || memes.length === 0) {
        feedEmpty.style.display = "block";
        return;
      }
      feedEmpty.style.display = "none";
      memes.forEach(meme => {
        if(meme.flagged && !isAdmin()) return; // hide flagged from normal users
        const memeDiv = document.createElement("div");
        memeDiv.className = "meme-card";
        // Image
        const img = document.createElement("img");
        img.src = storage.getFilePreview(APPWRITE_BUCKET, meme.image);
        img.alt = "Meme";
        memeDiv.appendChild(img);
        // Caption
        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = meme.caption || "";
        memeDiv.appendChild(cap);
        // Meta
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `By: ${meme.user || "anon"}`;
        memeDiv.appendChild(meta);
        // Reactions/Likes
        const actions = document.createElement("div");
        actions.className = "actions";
        actions.innerHTML = `
          <button title="Like">üëç</button> <span>${meme.likes||0}</span>
          <button title="Love">‚ù§Ô∏è</button>
          <button class="flag-btn" title="Flag" style="float:right;">üö©</button>
        `;
        // Like button
        actions.children[0].onclick = async () => {
          await databases.updateDocument(APPWRITE_DB, APPWRITE_COLLECTION, meme.$id, { likes: (meme.likes||0)+1 });
          await addNotif(meme.user, `${user.email} liked your meme!`);
          // Update leaderboard
          const uDoc = await getUserDoc(meme.user);
          if (uDoc) await databases.updateDocument(APPWRITE_DB, APPWRITE_USERS, uDoc.$id, { likes: (uDoc.likes||0)+1 });
        };
        // Love button
        actions.children[2].onclick = async () => {
          let reacts = meme.reactions || {};
          reacts.love = (reacts.love||0)+1;
          await databases.updateDocument(APPWRITE_DB, APPWRITE_COLLECTION, meme.$id, { reactions: reacts });
          await addNotif(meme.user, `${user.email} loved your meme!`);
        };
        // Flag button
        actions.children[4].onclick = async () => {
          await databases.updateDocument(APPWRITE_DB, APPWRITE_COLLECTION, meme.$id, { flagged: true });
          await addNotif(ADMIN_EMAILS[0], `${user.email} flagged a meme.`);
        };
        memeDiv.appendChild(actions);
        // Comments
        const commentsSection = document.createElement("div");
        commentsSection.className = "comment-list";
        if(meme.comments && meme.comments.length>0) {
          meme.comments.forEach(c =>
            commentsSection.innerHTML += `
              <div class="comment-card">
                <div class="meta">${c.user||'anon'}:</div>
                <div>${c.text}</div>
              </div>
            `);
        }
        // Add comment form
        const commentForm = document.createElement("form");
        commentForm.innerHTML = `
          <input type="text" placeholder="Add a comment..." class="input" maxlength="120" required>
          <button class="btn" type="submit">Post</button>
        `;
        commentForm.onsubmit = async (e) => {
          e.preventDefault();
          const val = commentForm.querySelector('input').value;
          let newComments = meme.comments || [];
          newComments.push({user: user.email, text: val});
          await databases.updateDocument(APPWRITE_DB, APPWRITE_COLLECTION, meme.$id, { comments: newComments });
          commentForm.reset();
          await addNotif(meme.user, `${user.email} commented on your meme!`);
        };
        commentsSection.appendChild(commentForm);
        memeDiv.appendChild(commentsSection);
        memeFeed.appendChild(memeDiv);
      });
    }

    // ==== Leaderboard ====
    async function renderLeaderboard() {
      try {
        const docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_USERS, ['orderDesc(likes)'], 5);
        leaderboardList.innerHTML = "";
        docs.documents.forEach((u, i) => {
          leaderboardList.innerHTML += `<li>${u.email} ‚Äî ${u.likes||0} likes, ${u.memes||0} memes</li>`;
        });
        leaderboardPanel.style.display = "block";
      } catch {
        leaderboardPanel.style.display = "none";
      }
    }

    // ==== Admin Panel ====
    async function renderAdmin() {
      if (!isAdmin()) {
        adminPanel.style.display = "none";
        return;
      }
      try {
        const docs = memes.filter(m => m.flagged);
        flaggedMemes.innerHTML = docs.length
          ? docs.map(m =>
              `<div class="admin-meme">
                 <img src="${storage.getFilePreview(APPWRITE_BUCKET, m.image)}">
                 <span>${m.caption} by ${m.user}</span>
                 <button class="remove-btn" onclick="removeMeme('${m.$id}')">Remove</button>
               </div>`
            ).join("")
          : "<em>No flagged memes.</em>";
        adminPanel.style.display = "block";
      } catch {
        adminPanel.style.display = "none";
      }
    }
    // Remove meme (admin only)
    window.removeMeme = async function(id) {
      await databases.deleteDocument(APPWRITE_DB, APPWRITE_COLLECTION, id);
      await addNotif(ADMIN_EMAILS[0], `A meme was removed by admin.`);
    };

    function isAdmin() {
      return ADMIN_EMAILS.includes(user.email);
    }

    // ==== Direct Messages ====
    async function renderDM() {
      try {
        const docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_USERS, []);
        allUsers = docs.documents;
        dmUserSelect.innerHTML = allUsers.filter(u=>u.email!==user.email).map(u=>
          `<option value="${u.email}">${u.email}</option>`
        ).join("");
        if (allUsers.length>1) {
          selectedDMUser = dmUserSelect.value = allUsers.find(u=>u.email!==user.email).email;
          loadDMs(selectedDMUser);
        } else {
          dmMessages.innerHTML = "<em>No other users yet!</em>";
        }
        dmUserSelect.onchange = () => {
          selectedDMUser = dmUserSelect.value;
          loadDMs(selectedDMUser);
        };
        dmPanel.style.display = "block";
      } catch {
        dmPanel.style.display = "none";
      }
    }
    async function loadDMs(withUser) {
      // Show all DMs between me and withUser (in either direction)
      if (myDMSubscription) myDMSubscription();
      dmMessages.innerHTML = "<em>Loading...</em>";
      try {
        const docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_DMS, [
          `or(user1=${user.email},user2=${user.email})`,
          `or(user1=${withUser},user2=${withUser})`
        ]);
        const msgs = docs.documents.filter(
          d => (d.user1===user.email && d.user2===withUser) || (d.user2===user.email && d.user1===withUser)
        ).sort((a,b)=>a.$createdAt.localeCompare(b.$createdAt));
        dmMessages.innerHTML = msgs.length
          ? msgs.map(m =>
            `<div class="dm-message${m.user1===user.email?' you':''}">
              <b>${m.user1}:</b> ${m.text}
            </div>`
          ).join("") : "<em>No messages yet.</em>";
        // Subscribe for new
        myDMSubscription = realtime.subscribe(`databases.${APPWRITE_DB}.collections.${APPWRITE_DMS}.documents`, e => {
          if (e.payload.user1===user.email && e.payload.user2===withUser || e.payload.user2===user.email && e.payload.user1===withUser) {
            loadDMs(withUser);
          }
        });
      } catch {
        dmMessages.innerHTML = "<em>Error loading DMs</em>";
      }
    }
    dmForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!selectedDMUser) return;
      const txt = dmInput.value;
      await databases.createDocument(APPWRITE_DB, APPWRITE_DMS, ID.unique(), {
        user1: user.email,
        user2: selectedDMUser,
        text: txt
      });
      await addNotif(selectedDMUser, `${user.email} sent you a DM: "${txt}"`);
      dmInput.value = "";
    };

    // ==== Notifications ====
    async function addNotif(to, msg) {
      await databases.createDocument(APPWRITE_DB, APPWRITE_NOTIFS, ID.unique(), {
        to,
        msg,
        seen: false,
        date: new Date().toISOString()
      });
    }
    async function renderNotifications() {
      try {
        // Load my notifs
        const docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_NOTIFS, [
          `to=${user.email}`,
          "orderDesc(date)"
        ]);
        myNotifs = docs.documents;
        notificationsList.innerHTML = myNotifs.length
          ? myNotifs.map(n =>
            `<div class="notification-item">${n.msg} <small>${new Date(n.date).toLocaleString()}</small></div>`
          ).join("")
          : "<em>No notifications yet.</em>";
        notificationsPanel.style.display = "block";
      } catch {
        notificationsPanel.style.display = "none";
      }
    }

    // ==== Helper: Get user doc by email ====
    async function getUserDoc(email) {
      try {
        const docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_USERS, [`email=${email}`]);
        return docs.documents[0] || null;
      } catch { return null; }
    }

    // ==== Real-time ====
    function subscribeFeed() {
      if (unsubscribeFeed) unsubscribeFeed(); // Remove previous
      unsubscribeFeed = realtime.subscribe(`databases.${APPWRITE_DB}.collections.${APPWRITE_COLLECTION}.documents`, response => {
        fetchMemes();
        renderLeaderboard();
        renderAdmin();
      });
      // Notifications real-time
      realtime.subscribe(`databases.${APPWRITE_DB}.collections.${APPWRITE_NOTIFS}.documents`, e => {
        renderNotifications();
      });
    }

    // ==== App Show ====
    function showApp() {
      userWelcome.innerHTML = `Welcome, <b>${user.email}</b>!`;
      authCard.classList.add('hidden');
      appCard.classList.remove('hidden');
      logoutBtn.style.display = "inline-block";
      fetchMemes();
      renderLeaderboard();
      renderAdmin();
      renderDM();
      renderNotifications();
      subscribeFeed();
    }

    // ==== On Load ====
    window.addEventListener("DOMContentLoaded", () => {
      checkSession();
    });
  </script>
</body>
</html>
